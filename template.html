<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>{{company}} — Audit Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#fafafa; color:#111; }
    .kpi { display:flex; gap:12px; align-items:center; }
    .card { background:white; border-radius:8px; padding:12px 16px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
    .chart-container { margin-bottom:28px; }
    .table-row:hover { background:#f7fafc; }
    .filter-bar { gap:12px; display:flex; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body class="p-6">

<header class="mb-6">
  <div class="flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-bold">{{company}}</h1>
      <div class="text-sm text-gray-600">Audit date: {{audit_date}} • Report generated: {{generated_at}}</div>
    </div>
    <div style="text-align:right">
      <button id="downloadBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">⬇ Download Report</button>
    </div>
  </div>

  <div class="kpi mt-4">
    <div class="card">
      <div class="text-xs text-gray-500">High Risks</div>
      <div class="text-2xl font-semibold text-red-600">{{kpis.high}}</div>
    </div>
    <div class="card">
      <div class="text-xs text-gray-500">Medium Risks</div>
      <div class="text-2xl font-semibold text-yellow-600">{{kpis.med}}</div>
    </div>
    <div class="card">
      <div class="text-xs text-gray-500">Low Risks</div>
      <div class="text-2xl font-semibold text-green-600">{{kpis.low}}</div>
    </div>
    <div class="card">
      <div class="text-xs text-gray-500">Total Observations</div>
      <div class="text-2xl font-semibold">{{kpis.total}}</div>
    </div>
  </div>
</header>

<section class="card mb-6">
  <h2 class="text-lg font-semibold mb-2">Executive Summary</h2>
  <div id="execSummary" class="text-sm text-gray-800">{{exec_summary}}</div>
</section>

<section class="card mb-6">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold">Interactive Charts</h3>
    <div class="filter-bar">
      <select id="priorityFilter" class="p-2 border rounded">
        <option value="ALL">All Priorities</option>
        <option value="HIGH">High</option>
        <option value="MEDIUM">Medium</option>
        <option value="LOW">Low</option>
      </select>

      <select id="locationFilter" class="p-2 border rounded">
        <option value="ALL">All Locations</option>
      </select>

      <input id="textSearch" placeholder="Search observations..." class="p-2 border rounded" />
      <button id="resetFilters" class="px-3 py-1 border rounded">Reset</button>
    </div>
  </div>

  <div id="chartsArea">
    <div id="chart_sunburst" class="chart-container"></div>
    <div id="chart_hazard_bar" class="chart-container"></div>
    <div id="chart_risk_matrix" class="chart-container"></div>
    <div id="chart_top_assets" class="chart-container"></div>
    <div id="chart_priority_hist" class="chart-container"></div>
  </div>
</section>

<section class="card mb-6">
  <h3 class="text-lg font-semibold mb-3">Top Findings</h3>
  <div id="findingsList"></div>
</section>

<footer class="text-sm text-gray-500 mt-8">
  Generated by Audit Dashboard • Methodology: normalized data → AI summaries (if available) → interactive charts.
</footer>

<script>
// ---------------- embed data from python ----------------
const DATA = {{ data_json | safe }};
const KPIS = {{ kpis_json | safe }};
const GENERATED = "{{generated_at}}";
// -------------------------------------------------------
document.getElementById('execSummary').innerText = `{{exec_summary_short|default('No executive summary available')}}`;

// populate location filter
const locations = Array.from(new Set(DATA.map(d => d["Location_Norm"] || "OTHER"))).sort();
const locSelect = document.getElementById("locationFilter");
locations.forEach(l => {
  const o = document.createElement("option");
  o.value = l;
  o.innerText = l;
  locSelect.appendChild(o);
});

// Utilities
function filterData(priority='ALL', location='ALL', text='') {
  let arr = DATA.slice();
  if (priority !== 'ALL') arr = arr.filter(r => (r.Priority || '').toUpperCase() === priority);
  if (location !== 'ALL') arr = arr.filter(r => (r.Location_Norm || '') === location);
  if (text && text.trim().length>0) {
    const q = text.toLowerCase();
    arr = arr.filter(r => ((r.Observation||'')+ ' ' + (r.Recommendation||'') + ' ' + (r["Type of Hazard"] || '')).toLowerCase().includes(q));
  }
  return arr;
}

// Helper to build hover text
function hoverText(d) {
  let s = "";
  if (d.Observation) s += "Obs: " + d.Observation;
  if (d.Recommendation) s += "<br>Rec: " + d.Recommendation;
  if (d.ai_summary) s += "<br>AI: " + d.ai_summary;
  return s;
}

// DRAW FUNCTIONS
function drawSunburst(data) {
  const agg = {};
  data.forEach(r => {
    const loc = r.Location_Norm || "OTHER";
    const haz = r["Type of Hazard"] || "OTHER";
    const pri = (r.Priority || "OTHER").toUpperCase();
    const key = `${loc}||${haz}||${pri}`;
    agg[key] = (agg[key] || 0) + (Number(r.Risk_Score) || 0);
  });
  const rows = [];
  for (const k in agg) {
    const [loc, haz, pri] = k.split("||");
    rows.push({loc, haz, pri, value: agg[k]});
  }
  const nodeMap = {};
  function addPath(p, val) {
    let parentId = "";
    for (let i=0;i<p.length;i++){
      const label = p[i];
      const id = parentId ? parentId + ">" + label : label;
      if (!nodeMap[id]) {
        nodeMap[id] = {label: label, parent: parentId, value: 0};
      }
      nodeMap[id].value += (i===p.length-1) ? val : 0;
      parentId = id;
    }
  }
  rows.forEach(r => addPath([r.loc, r.haz, r.pri], r.value));
  const labelsArr = [], parentsArr = [], valuesArr = [];
  for (const id in nodeMap) {
    labelsArr.push(nodeMap[id].label);
    parentsArr.push(nodeMap[id].parent || "");
    valuesArr.push(nodeMap[id].value || 0);
  }
  const dataPlot = [{
    type: "sunburst",
    labels: labelsArr,
    parents: parentsArr,
    values: valuesArr,
    branchvalues: "total",
    hovertemplate: "%{label}<br>Risk: %{value}<extra></extra>"
  }];
  const layout = {margin:{t:30,b:0,l:0,r:0}, height:450};
  Plotly.newPlot("chart_sunburst", dataPlot, layout, {responsive:true});
}

function drawHazardBar(data) {
  const agg = {};
  data.forEach(r => { const k = r["Type of Hazard"] || "OTHER"; agg[k] = (agg[k]||0) + (Number(r.Risk_Score)||0); });
  const keys = Object.keys(agg).sort((a,b)=>agg[b]-agg[a]);
  const vals = keys.map(k=>agg[k]);
  const trace = {x: keys, y: vals, type:'bar', marker:{color:'#ef4444'}, hovertemplate: '%{x}<br>Risk: %{y}<extra></extra>'};
  const layout = {margin:{t:30}, height:400};
  Plotly.newPlot("chart_hazard_bar",[trace],layout,{responsive:true});
}

function drawRiskMatrix(data) {
  const x = data.map(r=>Number(r.Priority_Score)||0);
  const y = data.map(r=>Number(r.Risk_Score)||0);
  const text = data.map(r=>hoverText(r));
  const marker = {size: data.map(r=> Math.max(6, Math.min(30, Math.round((Number(r.Risk_Score)||0)*3)))), sizemode:'area'};
  const trace = {x, y, mode:'markers', marker, text, hoverinfo:'text', type:'scatter'};
  const layout = {xaxis:{title:'Priority Score'}, yaxis:{title:'Risk Score'}, height:450, margin:{t:30}};
  Plotly.newPlot("chart_risk_matrix",[trace],layout,{responsive:true});
}

function drawTopAssets(data) {
  const agg = {};
  data.forEach(r=>{ const k = r["Asset Category"] || "UNKNOWN"; agg[k] = (agg[k]||0) + (Number(r.Risk_Score)||0); });
  const entries = Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const names = entries.map(e=>e[0]); const vals = entries.map(e=>e[1]);
  const trace = {x: vals, y: names, orientation:'h', type:'bar', marker:{color:'#6366f1'}, hovertemplate: '%{y}<br>Risk: %{x}<extra></extra>'};
  const layout = {height:400, margin:{t:30}};
  Plotly.newPlot("chart_top_assets",[trace],layout,{responsive:true});
}

function drawPriorityHist(data) {
  const priorities = {};
  data.forEach(r => { const p = (r.Priority||'OTHER').toUpperCase(); priorities[p] = (priorities[p]||0)+1; });
  const keys = Object.keys(priorities); const vals = keys.map(k=>priorities[k]);
  const trace = {x: keys, y: vals, type:'bar', marker:{color:'#10b981'}, hovertemplate:'%{x}<br>Count: %{y}<extra></extra>'};
  const layout = {height:300, margin:{t:20}};
  Plotly.newPlot("chart_priority_hist",[trace],layout,{responsive:true});
}

function renderFindingsList(data) {
  const container = document.getElementById("findingsList");
  container.innerHTML = "";
  data.slice(0, 200).forEach(r => {
    const div = document.createElement("div");
    div.className = "table-row p-3 border-b";
    const imgHtml = r.Image ? `<img src="${r.Image}" style="width:140px;height:90px;object-fit:cover;margin-right:12px;border-radius:6px;border:1px solid #e5e7eb">` : "";
    div.innerHTML = `<div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <div class="text-sm text-gray-600">#${r["Sr. No"]} • ${r.Priority} • ${r["Type of Hazard"]} • ${r.Location_Norm}</div>
        <div style="font-weight:600;margin-top:6px;">${r.Observation}</div>
        <div style="margin-top:6px;color:#444;"><strong>Recommendation:</strong> ${r.Recommendation}</div>
        ${r.ai_summary ? `<div style="margin-top:6px;color:#0f172a;"><strong>AI:</strong> ${r.ai_summary}</div>` : ""}
      </div>
      <div style="width:160px">${imgHtml}</div>
    </div>`;
    container.appendChild(div);
  });
}

// Main redraw
function redraw() {
  const priority = document.getElementById("priorityFilter").value;
  const location = document.getElementById("locationFilter").value;
  const text = document.getElementById("textSearch").value;
  const filtered = filterData(priority, location, text);
  drawSunburst(filtered);
  drawHazardBar(filtered);
  drawRiskMatrix(filtered);
  drawTopAssets(filtered);
  drawPriorityHist(filtered);
  renderFindingsList(filtered);
}

// wire events
document.getElementById("priorityFilter").addEventListener("change", redraw);
document.getElementById("locationFilter").addEventListener("change", redraw);
document.getElementById("textSearch").addEventListener("input", function(){ setTimeout(redraw, 200); });
document.getElementById("resetFilters").addEventListener("click", function(){
  document.getElementById("priorityFilter").value = 'ALL';
  document.getElementById("locationFilter").value = 'ALL';
  document.getElementById("textSearch").value = '';
  redraw();
});

// initial draw
redraw();

// PDF Download
document.getElementById("downloadBtn").addEventListener("click", function(){
  const opt = {
    margin:       0.5,
    filename:     '{{company}}_audit_report_{{generated_at}}.pdf',
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 1, useCORS: true },
    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().from(document.body).set(opt).save();
});
</script>

</body>
</html>
